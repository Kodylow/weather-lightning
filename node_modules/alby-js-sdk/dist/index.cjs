var e=require("crypto-js"),t=require("cross-fetch"),r=require("nostr-tools");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/n(e),i=/*#__PURE__*/n(t);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},s.apply(this,arguments)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function a(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function l(e,t,r){return l=a()?Reflect.construct.bind():function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&c(o,r.prototype),o},l.apply(null,arguments)}function h(e){var t="function"==typeof Map?new Map:void 0;return h=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return l(e,arguments,u(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,e)},h(e)}function d(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}function f(e){return Object.entries(e).map(function(e){var t=e[0],r=e[1];return t&&r?t+"="+r:""}).join("&")}function p(e,t){return"Basic "+btoa(e+":"+t)}var v=["auth","endpoint","params","request_body","method","max_retries","base_url","headers"],m=function(e){return Promise.resolve(y(e)).then(function(e){return e.json()})},y=function(e){var t=e.auth,r=e.endpoint,n=e.params,o=void 0===n?{}:n,i=e.request_body,u=e.method,c=e.max_retries,a=e.base_url,l=void 0===a?b:a,h=e.headers,p=d(e,v);try{var m=function(e){return Promise.resolve(w(y.toString(),s({headers:s({},P?{"Content-Type":"application/json; charset=utf-8"}:void 0,e,h),method:u,body:P?JSON.stringify(i):void 0},p),c)).then(function(e){var t=function(){if(!e.ok)return Promise.resolve(e.json()).then(function(t){throw new g(e.status,e.statusText,e.headers,t)})}();return t&&t.then?t.then(function(t){return e}):e})},y=new URL(l+r);y.search=f(o);var P="POST"===u&&!!i;return Promise.resolve(t?Promise.resolve(t.getAuthHeader(y.href,u)).then(m):m(void 0))}catch(e){return Promise.reject(e)}},w=function e(t,r,n){void 0===n&&(n=0);try{return Promise.resolve(i.default(t,r)).then(function(o){var i,s=function(){if(429===o.status&&n>0){var s=Number(o.headers.get("x-rate-limit-reset")),u=Number(o.headers.get("x-rate-limit-remaining")),c=1e3*s-Date.now(),a=1e3;return 0===u&&(a=c),Promise.resolve(new Promise(function(e){return setTimeout(e,a)})).then(function(){var o=e(t,r,n-1);return i=1,o})}}();return s&&s.then?s.then(function(e){return i?e:o}):i?s:o})}catch(e){return Promise.reject(e)}},b="https://api.getalby.com",g=/*#__PURE__*/function(e){var t,r;function n(t,r,n,o){var i;return(i=e.call(this)||this).status=void 0,i.statusText=void 0,i.headers=void 0,i.error=void 0,i.status=t,i.statusText=r,i.headers=n,i.error=o,i}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,c(t,r),n}(/*#__PURE__*/h(Error)),P=["expires_in"],_=["token"];function k(e){var t=e.expires_in;return s({},d(e,P),!!t&&{expires_at:Date.now()+1e3*t})}var E=/*#__PURE__*/function(){function e(e){this.token=void 0,this.options=void 0,this.code_verifier=void 0,this.code_challenge=void 0;var t=e.token,r=d(e,_);this.options=s({client_secret:""},r),this.token=t}var t=e.prototype;return t.refreshAccessToken=function(){try{var e,t=this,r=null==(e=t.token)?void 0:e.refresh_token,n=t.options,o=n.client_id,i=n.client_secret,u=n.request_options;if(!o)throw new Error("client_id is required");if(!r)throw new Error("refresh_token is required");return Promise.resolve(m(s({},u,{endpoint:"/oauth/token",params:{client_id:o,grant_type:"refresh_token",refresh_token:r},method:"POST",headers:s({},null==u?void 0:u.headers,{"Content-type":"application/x-www-form-urlencoded"},{Authorization:p(o,i)})}))).then(function(e){var r=k(e);return t.token=r,{token:r}})}catch(e){return Promise.reject(e)}},t.isAccessTokenExpired=function(){var e,t,r=null==(e=this.token)?void 0:e.refresh_token,n=null==(t=this.token)?void 0:t.expires_at;return!n||!!r&&n<=Date.now()+1e3},t.requestAccessToken=function(e){try{var t=this,r=t.options,n=r.client_id,o=r.client_secret,i=r.callback,u=r.request_options,c=t.code_verifier;if(!n)throw new Error("client_id is required");if(!i)throw new Error("callback is required");return Promise.resolve(m(s({},u,{endpoint:"/oauth/token",params:{code:e,grant_type:"authorization_code",code_verifier:c,client_id:n,redirect_uri:i},method:"POST",headers:s({},null==u?void 0:u.headers,{"Content-Type":"application/x-www-form-urlencoded"},{Authorization:p(n,o)})}))).then(function(e){var r=k(e);return t.token=r,{token:r}})}catch(e){return Promise.reject(e)}},t.generateAuthURL=function(e){e||(e={}),console.log(e);var t,r=this.options,n=r.client_id,i=r.callback,u=r.scopes;if(!i)throw new Error("callback required");if(!u)throw new Error("scopes required");if("S256"===e.code_challenge_method){var c=o.default.lib.WordArray.random(64);this.code_verifier=c.toString(),this.code_challenge=o.default.SHA256(this.code_verifier).toString(o.default.enc.Base64).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,""),t="S256"}else"plain"===e.code_challenge_method&&e.code_challenge&&(this.code_challenge=e.code_challenge,this.code_verifier=e.code_challenge,t="plain");var a=this.code_challenge,l=new URL("https://getalby.com/oauth");return l.search=f(s({},e,{client_id:n,scope:u.join(" "),response_type:"code",redirect_uri:i,code_challenge_method:t,code_challenge:a})),l.toString()},t.getAuthHeader=function(){try{var e,t=function(){return{Authorization:"Bearer "+r.token.access_token}},r=this;if(null==(e=r.token)||!e.access_token)throw new Error("access_token is required");var n=function(){if(r.isAccessTokenExpired())return Promise.resolve(r.refreshAccessToken()).then(function(){})}();return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},e}(),O=/*#__PURE__*/function(){function e(e){this.bearer_token=void 0,this.bearer_token=e}return e.prototype.getAuthHeader=function(){return{Authorization:"Bearer "+this.bearer_token}},e}(),j={__proto__:null,OAuth2User:E,OAuth2Bearer:O},q={alby:{authorizationUrl:"https://nwc.getalby.com/apps/new",relayUrl:"wss://relay.getalby.com/v1",walletPubkey:"69effe7b49a6dd5cf525bd0905917a5005ffe480b58eeb8e861418cf3ae760d9"}},T=/*#__PURE__*/function(){function e(t){var n;this.relay=void 0,this.relayUrl=void 0,this.secret=void 0,this.walletPubkey=void 0,this.options=void 0,this.subscribers=void 0,t&&t.nostrWalletConnectUrl&&(t=s({},e.parseWalletConnectUrl(t.nostrWalletConnectUrl),t));var o=q[(null==(n=t)?void 0:n.providerName)||"alby"];this.options=s({},o,t||{}),this.relayUrl=this.options.relayUrl,this.relay=r.relayInit(this.relayUrl),this.options.secret&&(this.secret=this.options.secret.toLowerCase().startsWith("nsec")?r.nip19.decode(this.options.secret).data:this.options.secret),this.walletPubkey=this.options.walletPubkey.toLowerCase().startsWith("npub")?r.nip19.decode(this.options.walletPubkey).data:this.options.walletPubkey,this.subscribers={},void 0===globalThis.WebSocket&&console.error("WebSocket is undefined. Make sure to `import websocket-polyfill` for nodejs environments")}e.parseWalletConnectUrl=function(e){e=e.replace("nostrwalletconnect://","http://").replace("nostr+walletconnect://","http://");var t=new URL(e),r={};r.walletPubkey=t.host;var n=t.searchParams.get("secret"),o=t.searchParams.get("relay");return n&&(r.secret=n),o&&(r.relayUrl=o),r},e.withNewSecret=function(t){return(t=t||{}).secret=r.generatePrivateKey(),new e(t)};var t,n,o=e.prototype;return o.on=function(e,t){this.subscribers[e]=t},o.notify=function(e,t){var r=this.subscribers[e];r&&r(t)},o.getNostrWalletConnectUrl=function(e){void 0===e&&(e=!0);var t="nostr+walletconnect://"+this.walletPubkey+"?relay="+this.relayUrl+"&pubkey="+this.publicKey;return e&&(t=t+"&secret="+this.secret),t},o.signEvent=function(e){if(!this.secret)throw new Error("Missing secret key");return r.signEvent(e,this.secret)},o.getEventHash=function(e){return r.getEventHash(e)},o.enable=function(){try{return this.connected?Promise.resolve():Promise.resolve(this.relay.connect()).then(function(){})}catch(e){return Promise.reject(e)}},o.close=function(){return this.relay.close()},o.encrypt=function(e,t){try{if(!this.secret)throw new Error("Missing secret");return Promise.resolve(r.nip04.encrypt(this.secret,e,t))}catch(e){return Promise.reject(e)}},o.decrypt=function(e,t){try{if(!this.secret)throw new Error("Missing secret");return Promise.resolve(r.nip04.decrypt(this.secret,e,t))}catch(e){return Promise.reject(e)}},o.getInfo=function(){try{return Promise.resolve({methods:["getInfo","sendPayment"],node:{},supports:["lightning"],version:"NWC"})}catch(e){return Promise.reject(e)}},o.sendPayment=function(e){var t=this;return this.checkConnected(),new Promise(function(r,n){try{return Promise.resolve(t.encrypt(t.walletPubkey,JSON.stringify({method:"pay_invoice",params:{invoice:e}}))).then(function(e){var o={kind:23194,created_at:Math.floor(Date.now()/1e3),tags:[["p",t.walletPubkey]],content:e};o.pubkey=t.publicKey,o.id=t.getEventHash(o),o.sig=t.signEvent(o);var i=t.relay.sub([{kinds:[23195],authors:[t.walletPubkey],"#e":[o.id]}]),s=setTimeout(function(){i.unsub(),n("reply timeout: event "+o.id)},6e4);i.on("event",function(e){try{return clearTimeout(s),i.unsub(),Promise.resolve(t.decrypt(t.walletPubkey,e.content)).then(function(o){var i,s,u,c;try{s=JSON.parse(o)}catch(e){return void n({error:"invalid response",code:"INTERNAL"})}23195==e.kind&&null!=(i=s.result)&&i.preimage?(r({preimage:s.result.preimage}),t.notify("sendPayment",e.content)):n({error:null==(u=s.error)?void 0:u.message,code:null==(c=s.error)?void 0:c.code})})}catch(e){return Promise.reject(e)}});var u=t.relay.publish(o),c=setTimeout(function(){n({error:"Publish timeout: event "+o.id})},5e3);u.on("failed",function(e){clearTimeout(c),n({error:"Failed to publish request: "+e})}),u.on("ok",function(){clearTimeout(c)})})}catch(e){return Promise.reject(e)}})},o.getAuthorizationUrl=function(e){if(!this.options.authorizationUrl)throw new Error("Missing authorizationUrl option");var t=new URL(this.options.authorizationUrl);return null!=e&&e.name&&t.searchParams.set("c",null==e?void 0:e.name),t.searchParams.set("pubkey",this.publicKey),null!=e&&e.returnTo&&t.searchParams.set("return_to",e.returnTo),t},o.initNWC=function(e){void 0===e&&(e={}),e.name||(e.name=document.location.host);var t=this.getAuthorizationUrl(e),r=window.outerHeight/2+window.screenY-300,n=window.outerWidth/2+window.screenX-200;return new Promise(function(e,o){var i=window.open(t.toString(),document.title+" - Wallet Connect","height=600,width=400,top="+r+",left="+n);if(i){var s=function r(n){var o=n.data;o&&"nwc:success"===o.type&&n.origin===t.protocol+"//"+t.host&&(e(o),clearInterval(u),window.removeEventListener("message",r),i&&i.close())},u=setInterval(function(){i&&i.closed&&(o(),clearInterval(u),window.removeEventListener("message",s))},500);window.addEventListener("message",s)}else o()})},o.checkConnected=function(){if(!this.connected)throw new Error("please call enable() and await the promise before calling this function")},t=e,(n=[{key:"nostrWalletConnectUrl",get:function(){return this.getNostrWalletConnectUrl()}},{key:"connected",get:function(){return 1===this.relay.status}},{key:"publicKey",get:function(){if(!this.secret)throw new Error("Missing secret key");return r.getPublicKey(this.secret)}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),e}(),x=T;function A(e){var t={};return e.recipient.customKey&&e.recipient.customValue&&(t[e.recipient.customKey]=e.recipient.customValue),t[7629169]=JSON.stringify(e.boostagram),{destination:e.recipient.address,amount:e.amount,customRecords:t}}var U=/*#__PURE__*/function(){function e(e,t){this.auth=void 0,this.defaultRequestOptions=void 0,this.auth="string"==typeof e?new O(e):e,this.defaultRequestOptions=s({},t,{headers:s({"User-Agent":"alby-js-api"},null==t?void 0:t.headers)})}var t=e.prototype;return t.accountBalance=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/balance",params:e,method:"GET"}))},t.accountSummary=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/summary",params:e,method:"GET"}))},t.accountInformation=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/me",params:e,method:"GET"}))},t.accountValue4Value=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/value4value",params:e,method:"GET"}))},t.incomingInvoices=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/incoming",params:e,method:"GET"}))},t.outgoingInvoices=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/outgoing",params:e,method:"GET"}))},t.getInvoice=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/"+e,method:"GET"}))},t.createInvoice=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices",request_body:e,method:"POST"}))},t.keysend=function(e,t){var r,n;return Array.isArray(e)?(r="/payments/keysend/multi",n={keysends:e}):(r="/payments/keysend",n=e),m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:r,request_body:n,method:"POST"}))},t.sendPayment=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/bolt11",request_body:e,method:"POST"}))},t.sendBoostagram=function(e,t){var r,n;return Array.isArray(e)?(r="/payments/keysend/multi",n={keysends:e.map(function(e){return A(e)})}):(r="/payments/keysend",n=A(e)),m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:r,request_body:n,method:"POST"}))},t.sendToAlbyAccount=function(e,t){return m(s({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/keysend",request_body:{destination:"030a58b8653d32b99200a2334cfe913e51dc7d155aa0116c176657a4f1722677a3",customRecords:{696969:e.account},amount:e.amount,memo:e.memo},method:"POST"}))},e}();function R(e,t){try{var r=e()}catch(e){return t(!0,e)}return r&&r.then?r.then(t.bind(null,!1),t.bind(null,!0)):t(!1,r)}function S(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}var C={__proto__:null,NostrWebLNProvider:T,NWC:x,OauthWeblnProvider:/*#__PURE__*/function(){function e(e){this.client=void 0,this.auth=void 0,this.oauth=void 0,this.subscribers=void 0,this.isExecuting=void 0,this.auth=e.auth,this.client=new U(e.auth),this.oauth=!0,this.subscribers={},this.isExecuting=!1}var t=e.prototype;return t.on=function(e,t){this.subscribers[e]=t},t.notify=function(e,t){var r=this.subscribers[e];r&&r(t)},t.enable=function(){try{var e,t=this;return t.isExecuting?Promise.resolve():null!=(e=t.auth.token)&&e.access_token?Promise.resolve({enabled:!0}):Promise.resolve(function(){if("undefined"==typeof window||void 0===window.document)throw new Error("Missing access token");var e=R(function(){return t.isExecuting=!0,Promise.resolve(t.openAuthorization()).then(function(){})},function(e,r){if(t.isExecuting=!1,e)throw r;return r});if(e&&e.then)return e.then(function(){})}())}catch(e){return Promise.reject(e)}},t.sendPayment=function(e){try{var t=this;return t.isExecuting?Promise.resolve():Promise.resolve(R(function(){return S(function(){return t.isExecuting=!0,Promise.resolve(t.client.sendPayment({invoice:e})).then(function(e){if(e.error)throw new Error(e.message);return t.notify("sendPayment",e),{preimage:e.payment_preimage}})},function(e){var t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)})},function(e,r){if(t.isExecuting=!1,e)throw r;return r}))}catch(e){return Promise.reject(e)}},t.keysend=function(e){try{var t=this;return t.isExecuting?Promise.resolve():Promise.resolve(R(function(){return S(function(){return t.isExecuting=!0,Promise.resolve(t.client.keysend(e)).then(function(e){if(e.error)throw new Error(e.message);return t.notify("keysend",e),{preimage:e.payment_preimage}})},function(e){var t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)})},function(e,r){if(t.isExecuting=!1,e)throw r;return r}))}catch(e){return Promise.reject(e)}},t.getInfo=function(){try{return Promise.resolve({alias:"Alby"})}catch(e){return Promise.reject(e)}},t.makeInvoice=function(e){try{var t=this;return t.isExecuting?Promise.resolve():Promise.resolve(R(function(){return S(function(){return t.isExecuting=!0,Promise.resolve(t.client.createInvoice({amount:parseInt(e.amount.toString()),description:e.defaultMemo})).then(function(e){return t.notify("makeInvoice",e),{paymentRequest:e.payment_request}})},function(e){var t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)})},function(e,r){if(t.isExecuting=!1,e)throw r;return r}))}catch(e){return Promise.reject(e)}},t.openAuthorization=function(){var e=this,t=window.outerHeight/2+window.screenY-350,r=window.outerWidth/2+window.screenX-300,n=this.auth.generateAuthURL({code_challenge_method:"S256"});return new Promise(function(o,i){var s=window.open(n,document.title+" - WebLN enable","height=700,width=600,top="+t+",left="+r),u=!1;window.addEventListener("message",function(t){try{var r=t.data,n=function(){if(r&&"alby:oauth:success"===r.type&&t.origin===document.location.protocol+"//"+document.location.host&&!u){u=!0,console.info("Processing OAuth code response");var n=r.payload.code,c=S(function(){return Promise.resolve(e.auth.requestAccessToken(n)).then(function(){e.client=new U(e.auth),s&&s.close(),e.notify("enable"),o({enabled:!0})})},function(e){console.error(e),i({enabled:!1})});if(c&&c.then)return c.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})})},e}()};exports.Client=U,exports.auth=j,exports.types={__proto__:null,OAuthClient:function(){},AuthClient:function(){}},exports.webln=C;
//# sourceMappingURL=index.cjs.map
